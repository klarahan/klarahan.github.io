---
title: "Chapter 2: Framing Democracy"
subtitle: "Online Appendix"
---

```{r setup, include=FALSE}
setwd("C:/Users/hanou/Dropbox/RESEARCH/klarahan.github.io")
Sys.setlocale(locale = "Korean")
```

Load libraries
```{r message=FALSE, warning=FALSE}
library(lubridate)
library(ggplot2)
library(dplyr)
library(tidytext)
library(quanteda)
library(scales)
library(LSX)

```

Load the data.
```{r}
data_dem <- readRDS("data/data_dem_nouns")
```

# Overview
Trend  
```{r}
x <- data_dem %>%
  count(Newspaper, Government, Date, Prezparty) %>% 
    mutate(Government = case_when(
      Government == "1990-1993 Roh TW" ~ "1990-1993\nConservative\nRoh TW",
      Government == "1993-1998 Kim YS" ~ "1993-1998\nConservative\nKim YS", 
      Government == "1998-2003 Kim DJ" ~ "1998-2003\nLiberal\nKim DJ",
      Government == "2003-2008 Roh MH" ~ "2003-2008\nLiberal\nRoh MH",
      Government == "2008-2013 Lee MB" ~ "2008-2013\nConservative\nLee MB",
      Government == "2013-2014 Park GH" ~ "2013-2014\nConservative\nPark GH")) %>%
  ggplot(aes(Date, n, fill = Newspaper)) +
  geom_smooth(colour="black") +
  labs(x = "Year",
       y = "Count of daily articles",
       caption = "smoothed with generative additive models (GAM)") +
  scale_fill_grey() +
  theme_minimal() +
  theme(legend.position = "none",
      # strip.text.y.right = element_text(angle = 0),
      axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(axis.text.x=element_blank(),
        axis.title.x=element_blank()) +
  facet_grid(Newspaper~Government, scales = "free_x") 
x
ggsave("plots/2_dem_trend.jpg", width=8, height=4, dpi = 300)

```

Trend by presidential party position
```{r}
x <- data_dem %>%
  mutate(Date = year(Date)) %>% 
  count(Newspaper, Government, Date, Prezparty) %>% 
  group_by(Newspaper) %>%
  mutate(total_n = sum(n)) %>%
  mutate(freq = n / total_n) %>% 
  mutate(Government = case_when(
      Government == "1990-1993 Roh TW" ~ "1990-1993\nConservative\nRoh TW",
      Government == "1993-1998 Kim YS" ~ "1993-1998\nConservative\nKim YS", 
      Government == "1998-2003 Kim DJ" ~ "1998-2003\nLiberal\nKim DJ",
      Government == "2003-2008 Roh MH" ~ "2003-2008\nLiberal\nRoh MH",
      Government == "2008-2013 Lee MB" ~ "2008-2013\nConservative\nLee MB",
      Government == "2013-2014 Park GH" ~ "2013-2014\nConservative\nPark GH")) %>%
  ggplot(aes(Prezparty, freq, fill = Prezparty)) +
  geom_col() +
  labs(x = "Party of president",
       y = "Percentage of total articles") +
  scale_fill_grey() +
  theme_minimal() +
  theme(legend.position = "none",
      # strip.text.y.right = element_text(angle = 0),
      axis.text.x = element_text(angle = 30, hjust = 1)) +
  # theme(axis.text.x=element_blank(),
  #       axis.title.x=element_blank()) +
  facet_grid(.~Newspaper, scales = "free_x") 
x
ggsave("plots/2_dem_trend_pos.jpg", width=6, height=4, dpi = 300)

```

#Scaling
Load the Korean sentiment lexicon.
```{r emo, echo=FALSE}
# sentiment lexicon source:
# https://sites.google.com/site/datascienceslab/projects/multilingualsentiment
pos <- readr::read_delim("data/positive_words_ko.txt", delim='\t', col_names=c("term")) %>% 
  rename(word = term) %>% 
  tibble::add_column(sentiment = "positive")
neg <- readr::read_delim("data/negative_words_ko.txt", delim='\t', col_names=c("term")) %>% 
  rename(word = term) %>% 
  tibble::add_column(sentiment = "negative")
senti <- bind_rows(pos, neg) 
senti
```

Count the sentiment words.
```{r}
tidy_news <- data_dem %>% 
  unnest_tokens(word, text)

tidy_news %>%
  inner_join(senti) %>%
  count(word, sort = TRUE) 

senti_news <- tidy_news %>%
  inner_join(senti) %>%
  count(Newspaper, Prezparty, sentiment) %>%
  tidyr::spread(sentiment, n, fill = 0) %>%
  mutate(sentiment = positive - negative)

# pdf("neg_news.pdf", width=6, height=2)
ggplot(senti_news, aes(Prezparty, sentiment, fill = Newspaper)) +
  geom_col(show.legend = FALSE) +
  labs(x = "governments from 1990 to 2014") +
  facet_wrap(~Newspaper, ncol = 3, scales = "free_x") +
  scale_fill_grey() +
  theme_bw()
# dev.off()

```

See the top sentiment words.
```{r}
senti_word_counts <- tidy_news %>%
  inner_join(senti) %>%   
  filter(Government == "1990-1993 Roh TW") %>% 
  count(word, sentiment, Government, sort = TRUE) %>%
  ungroup()

senti_word_counts
```

Plot the top sentiment words.
```{r message=TRUE, warning=TRUE}
senti_word_counts %>%
  group_by(sentiment) %>%
  top_n(20) %>%
  ungroup() %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(aes(word, n, fill = sentiment)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~sentiment, scales = "free_y") +
  labs(y = "Contribution to sentiment",
       x = NULL) +
  coord_flip() +
  scale_fill_grey() +
  theme_bw()
```

```{r}
Sys.setlocale(locale = "C")
dem_sentiment <- dictionary(list(positive = c("개혁", "자유", "평화", "협력", "유지", "가능"),
                                 negative = c("투쟁", "평민", "반대", "시위", "비판", "위기")))
dem_sentiment
```


```{r}

# tokenize text corpus and remove various features
corp_sent <- data_dem %>% 
  corpus() %>% 
  corpus_reshape(to =  "sentences")
toks <- corp_sent %>% 
    tokens()

# create a document feature matrix from the tokens object
dfmat <- toks %>% 
    dfm(remove = "") %>% 
    dfm_trim(min_termfreq = 5)
```

```{r}
topfeatures(dfmat, 20)

```

```{r}
seed <- as.seedwords(dem_sentiment)
seed
```

```{r}
# identify context words 
dem <- char_context(toks, pattern = "*민주주의*", p = 0.05)

# run LSS model
tmod_lss <- textmodel_lss(dfmat, seeds = seed,
                          terms = dem, k = 300, cache = TRUE)
```

```{r}
head(coef(tmod_lss), 20) # most positive words

```

```{r}
tail(coef(tmod_lss), 20) # most negative words

```

```{r}
textplot_terms(tmod_lss, dem_sentiment["negative"])

```

```{r}
dfmat <- dfm_group(dfmat_sent)
# predict sentiment scores
pred <- as.data.frame(predict(tmod_lss, se.fit = TRUE, newdata = dfmat))
pred$date <- docvars(dfmat, "Date")
pred$Newspaper <- docvars(dfmat, "Newspaper")

```

```{r}
pred_sm_chos <- pred %>% 
  filter(Newspaper == "Chosun") %>% 
  smooth_lss(engine = "locfit")
pred_sm_hani <- pred %>% 
  filter(Newspaper == "Hankyoreh") %>% 
  smooth_lss(engine = "locfit")
pred_sm_hankook <- pred %>% 
  filter(Newspaper == "Hankook") %>% 
  smooth_lss(engine = "locfit")

Sys.setlocale(locale = "Korean")
head(pred_sm_chos)
head(pred_sm_hani)
head(pred_sm_hankook)

```

plot trend
```{r}
# jpeg("plots/2_dem_lss.jpg", res = 300, width = 8, height = 5, units = "in")

plot(pred$date, pred$fit, col = rgb(0, 0, 0, 0.03), pch = 16, ylim = c(-0.5, 0.5), 
     xlab = "Year", ylab = "Negative vs. positive")
lines(pred_sm_chos$date, pred_sm_chos$fit, type = "l", col = "black")
lines(pred_sm_chos$date, pred_sm_chos$fit + pred_sm_chos$se.fit * 2, type = "l", lty = 3)
lines(pred_sm_chos$date, pred_sm_chos$fit - pred_sm_chos$se.fit * 2, type = "l", lty = 3)
lines(pred_sm_hani$date, pred_sm_hani$fit, type = "l", col = "grey60")
lines(pred_sm_hani$date, pred_sm_hani$fit + pred_sm_hani$se.fit * 2, type = "l", lty = 3, col = "grey")
lines(pred_sm_hani$date, pred_sm_hani$fit - pred_sm_hani$se.fit * 2, type = "l", lty = 3, col = "grey")
# lines(pred_sm_hankook$date, pred_sm_hankook$fit, type = "l")
# lines(pred_sm_hankook$date, pred_sm_hankook$fit + pred_sm_hankook$se.fit * 2, type = "l", lty = 3)
# lines(pred_sm_hankook$date, pred_sm_hankook$fit - pred_sm_hankook$se.fit * 2, type = "l", lty = 3)
# abline(h = 0, v = as.Date("2012-12-19"), lty = c(1, 5))
# abline(h = 0, v = as.Date("2008-06-05"), lty = c(1, 5))
# abline(h = 0, v = as.Date("2000-06-13"), lty = c(1, 5))
legend("topleft", legend=c("Chosun", "Hankyoreh"),
       col=c("black", "grey50"), lty = 1, cex=0.8)

abline(h = 0, v = as.Date("1993-02-25"), lty = c(1, 1))
abline(h = 0, v = as.Date("1998-02-25"), lty = 1)
abline(h = 0, v = as.Date("2003-02-25"), lty = 1)
abline(h = 0, v = as.Date("2008-02-25"), lty = 1)
abline(h = 0, v = as.Date("2013-02-25"), lty = 1)

text(as.Date("1993-02-25"), -0.4, "Roh TW", adj = 0)
text(as.Date("1998-02-25"), -0.4, "2", adj = 1)
text(as.Date("2003-02-25"), -0.4, "1", adj = 1)
text(as.Date("2008-02-25"), -0.4, "2", adj = 1)
text(as.Date("2013-02-25"), -0.4, "1", adj = 1)

# text(as.Date("2012-12-19"), -0.4, "3", adj = 1)
# text(as.Date("2008-06-05"), -0.4, "2", adj = 1)
# text(as.Date("2000-06-13"), -0.4, "1", adj = 1)
# 
# caption <- c("1. Inter-Korean Summit
#              2. Beef Protests
#              3. 2012 Presidential election") 
# mtext(caption, side = 1, line = 4, cex = 0.8, adj = 1) 

# dev.off()

```
plot trend ggplot2
```{r}
bind_rows("Chosun" = pred_sm_chos, "Hankyoreh" = pred_sm_hani, .id = "Newspaper") %>% 
  mutate(date = as.Date(date, format = "ymd")) %>% 
  mutate(Newspaper = as.factor(Newspaper)) %>% 
  ggplot(aes(date, fit, group = Newspaper, color = Newspaper, fill = Newspaper)) +
  annotate("rect", xmin = as.Date("1998-02-25"), xmax = as.Date("2008-02-2"), 
           ymin = -Inf, ymax = Inf, alpha = 0.05) +
  geom_line() +
  geom_ribbon(aes(ymin = fit + se.fit, ymax = fit - se.fit), alpha = 0.3) +
  geom_hline(yintercept = 0) +
  # geom_vline(xintercept = as.Date(c("2000-06-13", "2008-06-05", "2012-12-19")),
  #            linetype = "dashed") +
  scale_color_manual(values = c("grey20", "grey70")) +
  theme_classic() +
  labs(x = "Year", y = "Negative vs. Positive",
       caption = "1. First Inter-Korean Summit\n2. Start of three-day mass protests against the US FTA\n3. 2012 presidential election and victory of Geun-hye Park")  +
  scale_x_date(breaks = "1 year", labels = date_format("%Y"), 
           limits = as.Date(c("1990-01-01", "2014-12-31")), expand = c(0,0)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))  +
  scale_fill_manual(values=c("grey20", "grey70")) +
  annotate(geom = "text", x = as.Date("1994-01-01"), y = 0.5, 
           label = "Conservative\ngovernments", hjust = "center") +
  annotate(geom = "text", x = as.Date("2003-01-01"), y = 0.5, 
           label = "Liberal\ngovernments", hjust = "center") +
  annotate(geom = "text", x = as.Date("2012-01-01"), y = 0.5, 
         label = "Conservative\ngovernments", hjust = "center") +
  annotate(geom = "text", x = as.Date("2000-06-13"), y = 0.38, 
         label = "1", hjust = "center", size = 4) +
  annotate(geom = "text", x = as.Date("2008-06-05"), y = 0.38, 
         label = "2", hjust = "center", size = 4) +
  annotate(geom = "text", x = as.Date("2012-12-19"), y = 0.38, 
         label = "3", hjust = "center", size = 4) +
  annotate("segment", x = as.Date(c("2000-06-13", "2008-06-05", "2012-12-19")),
           xend = as.Date(c("2000-06-13", "2008-06-05", "2012-12-19")), 
           y = - Inf, yend = 0.35, linetype = 3)


ggsave("plots/2_dem_lss.jpg", width=9, height= 5, dpi = 300)

```

# Keyness
Load the data.
```{r}
data_dem <- readRDS("data/toks_dem")
```

Prepare and check
```{r}
Sys.setlocale(locale = "C")

stopwords <- c("그래픽", "지난해", "한겨레", "기사", "기자", "본지", "측은", "작년", "신문", "종이", "우리", "지면", "보도", "생각", "이날", "간의")
# stopwords_wild <- c("경제민주화*")

dem_hani <- data_dem %>% 
  tokens_subset(docvars(data_dem, "Newspaper") == "Hankyoreh" &  
                docvars(data_dem, "Government") == c("2013-2014 Park GH", "1990-1993 Roh TW")) %>% 
  tokens_remove(pattern = stopwords, valuetype = "fixed") %>%
  # tokens_remove(pattern = stopwords_wild, valuetype = "glob") %>% 
  dfm()

dem_chos <- data_dem %>% 
  tokens_subset(docvars(data_dem, "Newspaper") == "Chosun" & 
                docvars(data_dem, "Government") == c("2013-2014 Park GH", "1990-1993 Roh TW")) %>% 
  tokens_remove(pattern = stopwords, valuetype = "fixed") %>%
  # tokens_remove(pattern = stopwords_wild, valuetype = "glob") %>% 
  dfm()

Sys.setlocale(locale = "Korean")
tstat_freq <- dem_hani %>% 
  dfm() %>% 
  textstat_frequency(n = 20, groups = "Government")
head(tstat_freq, 40)

tstat_freq <- dem_chos %>% 
  dfm() %>% 
  textstat_frequency(n = 20, groups = "Government")
head(tstat_freq, 40)

#text scaling
result_keyness_hani <- textstat_keyness(dem_hani, target = docvars(dem_hani, "Government") == "1990-1993 Roh TW") 
textplot_keyness(result_keyness_hani, n = 10, color = c("grey70", "grey90")) 
result_keyness_chos <- textstat_keyness(dem_chos, target = docvars(dem_chos, "Government") == "1990-1993 Roh TW") 
textplot_keyness(result_keyness_chos, n = 10, color = c("black", "grey45")) 


```
Look up stray words
```{r}
Sys.setlocale(locale = "C")
x <- data_dem %>% 
  tokens_subset(docvars(data_dem, "Newspaper") == "Chosun") %>% 
  kwic(pattern = "간의", window = 5, valuetype = "fixed")
Sys.setlocale(locale = "Korean")
x
```

Plot and label
```{r message=FALSE, warning=FALSE}
x <- textplot_keyness(result_keyness_hani, n = 10) +
  # xlim(-500, 900) +
  labs(color = "Hankyoreh",
       caption = "x-axis: chi-squared test for significance of observed versus expected frequency") +
  scale_color_manual(values = c("grey70", "grey90"), 
                     labels = c("1990-1993 Roh TW", "2013-2014 Park GH")) +
  annotate("text", x = -5, y = 20, label = "Democratic Liberal Party", hjust = 1) +
  annotate("text", x = -5, y = 19, label = "election", hjust = 1) +
  annotate("text", x = -5, y = 18, label = "candidate", hjust = 1) +
  annotate("text", x = -5, y = 17, label = "socialism", hjust = 1) +
  annotate("text", x = -5, y = 16, label = "Soviet Union", hjust = 1) +
  annotate("text", x = -5, y = 15, label = "Minjung ('the People')", hjust = 1) +
  annotate("text", x = -5, y = 14, label = "unification", hjust = 1) +
  annotate("text", x = -5, y = 13, label = "Minjok ('our Nation')", hjust = 1) +
  annotate("text", x = -5, y = 12, label = "Jaeya ('dissident leaders')", hjust = 1) +
  annotate("text", x = -5, y = 11, label = "party president", hjust = 1) +
  annotate("text", x = 5, y = 10, label = "Jongbuk ('Pro-North Korea')", hjust = 0) +
  annotate("text", x = 5, y = 9, label = "war", hjust = 0)  +
  annotate("text", x = 5, y = 8, label = "China", hjust = 0) +
  annotate("text", x = 5, y = 7, label = "Sewol Ferry", hjust = 0) +
  annotate("text", x = 5, y = 6, label = "Korea", hjust = 0) +
  annotate("text", x = 5, y = 5, label = "Hong Kong", hjust = 0) +
  annotate("text", x = 5, y = 4, label = "National Intelligence", hjust = 0) +
  annotate("text", x = 5, y = 3, label = "Park Geun-Hye", hjust = 0)+
  annotate("text", x = 5, y = 2, label = "Saenuri Party", hjust = 0) +
  annotate("text", x = 5, y = 1, label = "National Intelligence Service", hjust = 0)


# library(showtext)
# font_install(source_han_serif())
# showtext_auto()
x
ggsave("plots/2_dem_hani.jpg", width=7, height=4, dpi = 300)
# showtext_auto(FALSE)

```

```{r message=FALSE, warning=FALSE}
x <- textplot_keyness(result_keyness_chos, n = 10)  +
    labs(color = "Chosun Ilbo",
       caption = "x-axis: chi-squared test for significance of observed versus expected frequency") +
  scale_color_manual(values = c("black", "grey45"), 
                     labels = c("1990-1993 Roh TW", "2013-2014 Park GH")) +
  xlim(-800, 500) +
  annotate("text", x = -5, y = 20, label = "Soviet Union", hjust = 1) +
  annotate("text", x = -5, y = 19, label = "Democratic Liberal Party", hjust = 1) +
  annotate("text", x = -5, y = 18, label = "party president", hjust = 1) +
  annotate("text", x = -5, y = 17, label = "election", hjust = 1) +
  annotate("text", x = -5, y = 16, label = "candidate", hjust = 1) +
  annotate("text", x = -5, y = 15, label = "common citizen", hjust = 1) +
  annotate("text", x = -5, y = 14, label = "Gorbachev", hjust = 1) +
  annotate("text", x = -5, y = 13, label = "Young-sam Kim", hjust = 1) +
  annotate("text", x = -5, y = 12, label = "Local Autonomous Entity", hjust = 1) +
  annotate("text", x = -5, y = 11, label = "economy", hjust = 1) +
  annotate("text", x = 5, y = 10, label = "constitutional amendment", hjust = 0) +
  annotate("text", x = 5, y = 9, label = "Suk-gi Lee", hjust = 0)  +
  annotate("text", x = 5, y = 8, label = "MP", hjust = 0) +
  annotate("text", x = 5, y = 7, label = "dissolution", hjust = 0) +
  annotate("text", x = 5, y = 6, label = "school textbooks", hjust = 0) +
  annotate("text", x = 5, y = 5, label = "Geun-hye Park", hjust = 0) +
  annotate("text", x = 5, y = 4, label = "Republic of Korea", hjust = 0) +
  annotate("text", x = 5, y = 3, label = "Saenuri Party", hjust = 0)+
  annotate("text", x = 5, y = 2, label = "National Intelligence Service", hjust = 0) +
  annotate("text", x = 5, y = 1, label = "Unified Progressive Party", hjust = 0) 

# showtext_auto()
x
ggsave("plots/2_dem_chos.jpg", width=7, height=4, dpi = 300)
# showtext_auto(FALSE)

```

